{"version":3,"file":"index.js","sources":["../../src/modules/application/SvelteApplication.js","../../src/modules/application/TJSMenu.js"],"sourcesContent":["import { outroAndDestroy, parseSvelteConfig }   from '@typhonjs-fvtt/svelte/util';\r\n\r\n/**\r\n * Provides a Svelte aware extension to Application to control the app lifecycle appropriately. You can declaratively\r\n * load one or more components from `defaultOptions`. For the time being please refer to this temporary demo code\r\n * in `typhonjs-quest-log` for examples of how to declare Svelte components.\r\n * {@link https://github.com/typhonjs-fvtt/typhonjs-quest-log/tree/master/src/view/demo}\r\n *\r\n * A repository of demos will be available soon.\r\n */\r\nexport class SvelteApplication extends Application\r\n{\r\n   /**\r\n    * Stores SvelteData entries with instantiated Svelte components.\r\n    *\r\n    * @type {object[]}\r\n    * @private\r\n    */\r\n   #svelteData = [];\r\n\r\n   /**\r\n    * Stores the target element which may not necessarily be the main element.\r\n    *\r\n    * @type {JQuery}\r\n    */\r\n   #targetElement = null;\r\n\r\n   /**\r\n    * @inheritDoc\r\n    */\r\n   constructor(options)\r\n   {\r\n      super(options);\r\n   }\r\n\r\n   /**\r\n    * Returns the length of the SvelteData entry array.\r\n    *\r\n    * @returns {number} Number of SvelteData entries loaded.\r\n    */\r\n   get svelteDataLength() { return this.#svelteData.length; }\r\n\r\n   /**\r\n    * Returns the target element or main element if no target defined.\r\n    *\r\n    * @returns {JQuery} Target element.\r\n    */\r\n   get targetElement() { return this.#targetElement; }\r\n\r\n   /**\r\n    * Note: This method is fully overridden and duplicated as Svelte components need to be destroyed manually and the\r\n    * best visual result is to destroy them after the default JQuery slide up animation occurs, but before the element\r\n    * is removed from the DOM.\r\n    *\r\n    * If you destroy the Svelte components before the slide up animation the Svelte elements are removed immediately\r\n    * from the DOM. The purpose of overriding ensures the slide up animation is always completed before\r\n    * the Svelte components are destroyed and then the element is removed from the DOM.\r\n    *\r\n    * Close the application and un-register references to it within UI mappings.\r\n    * This function returns a Promise which resolves once the window closing animation concludes\r\n    *\r\n    * @param {object}   options - Optional parameters.\r\n    *\r\n    * @param {boolean}  options.force - Force close regardless of render state.\r\n    *\r\n    * @returns {Promise<void|number>}    A Promise which resolves once the application is closed\r\n    */\r\n   async close(options = {})\r\n   {\r\n      const states = Application.RENDER_STATES;\r\n      if (!options.force && ![states.RENDERED, states.ERROR].includes(this._state)) { return; }\r\n\r\n      this._state = states.CLOSING;\r\n\r\n      /**\r\n       * Get the element.\r\n       *\r\n       * @type {JQuery}\r\n       */\r\n      const el = this.#targetElement;\r\n      if (!el) { return this._state = states.CLOSED; }\r\n\r\n      el[0].style.minHeight = '0';\r\n\r\n      // Dispatch Hooks for closing the base and subclass applications\r\n      for (const cls of this.constructor._getInheritanceChain())\r\n      {\r\n         /**\r\n          * A hook event that fires whenever this Application is closed.\r\n          *\r\n          * @param {Application} app                     The Application instance being closed\r\n          *\r\n          * @param {jQuery[]} html                       The application HTML when it is closed\r\n          *\r\n          * @function closeApplication\r\n          *\r\n          * @memberof hookEvents\r\n          */\r\n         Hooks.call(`close${cls.name}`, this, el);\r\n      }\r\n\r\n      // Await on JQuery to slide up the main element.\r\n      await new Promise((resolve) => { el.slideUp(200, () => resolve()); });\r\n\r\n      // Stores the Promises returned from running outro transitions and destroying each Svelte component.\r\n      const svelteDestroyPromises = [];\r\n\r\n      // Manually invoke the destroy callbacks for all Svelte components.\r\n      for (const entry of this.#svelteData)\r\n      {\r\n         // Use `outroAndDestroy` to run outro transitions before destroying.\r\n         svelteDestroyPromises.push(outroAndDestroy(entry.component));\r\n\r\n         // If any proxy eventbus has been added then remove all event registrations from the component.\r\n         const eventbus = entry.config.eventbus;\r\n         if (typeof eventbus === 'object' && typeof eventbus.off === 'function')\r\n         {\r\n            eventbus.off();\r\n            entry.config.eventbus = void 0;\r\n         }\r\n      }\r\n\r\n      this.#svelteData = [];\r\n\r\n      // Await all Svelte components to destroy.\r\n      await Promise.all(svelteDestroyPromises);\r\n\r\n      el.remove();\r\n\r\n      // Clean up data\r\n      this._element = null;\r\n      this.#targetElement = null;\r\n      delete ui.windows[this.appId];\r\n      this._minimized = false;\r\n      this._scrollPositions = null;\r\n      this._state = states.CLOSED;\r\n   }\r\n\r\n   /**\r\n    * Returns the indexed SvelteData entry.\r\n    *\r\n    * @param {number}   index -\r\n    *\r\n    * @returns {object} The loaded Svelte config + component.\r\n    */\r\n   getSvelteData(index)\r\n   {\r\n      return this.#svelteData[index];\r\n   }\r\n\r\n   /**\r\n    * Returns the SvelteData entries iterator.\r\n    *\r\n    * @returns {IterableIterator<[number, Object]>} SvelteData entries iterator.\r\n    */\r\n   getSvelteDataEntries()\r\n   {\r\n      return this.#svelteData.entries();\r\n   }\r\n\r\n   /**\r\n    * Returns the SvelteData values iterator.\r\n    *\r\n    * @returns {IterableIterator<Object>} SvelteData values iterator.\r\n    */\r\n   getSvelteDataValues()\r\n   {\r\n      return this.#svelteData.values();\r\n   }\r\n\r\n   /**\r\n    * Inject the Svelte components defined in `this.options.svelte`. The Svelte component can attach to the existing\r\n    * pop-out of Application or provide no template and render into a document fragment which is then attached to the\r\n    * DOM.\r\n    *\r\n    * @param {JQuery} html -\r\n    *\r\n    * @override\r\n    * @inheritDoc\r\n    */\r\n   _injectHTML(html)\r\n   {\r\n      if (this.popOut && html.length === 0 && Array.isArray(this.options.svelte))\r\n      {\r\n         throw new Error(\r\n          'SvelteApplication - _injectHTML - A popout app with no template can only support one Svelte component.');\r\n      }\r\n\r\n      if (Array.isArray(this.options.svelte))\r\n      {\r\n         for (const svelteConfig of this.options.svelte)\r\n         {\r\n            this.#svelteData.push(s_LOAD_CONFIG(this, html, svelteConfig));\r\n         }\r\n      }\r\n      else if (typeof this.options.svelte === 'object')\r\n      {\r\n         this.#svelteData.push(s_LOAD_CONFIG(this, html, this.options.svelte));\r\n      }\r\n      else\r\n      {\r\n         throw new TypeError(`SvelteApplication - _injectHTML - this.options.svelte not an array or object.`);\r\n      }\r\n\r\n      // Detect if this is a synthesized DocumentFragment.\r\n      const isDocumentFragment = html.length && html[0] instanceof DocumentFragment;\r\n\r\n      super._injectHTML(html);\r\n\r\n      // Set the element of the app to the first child element in order of Svelte components mounted.\r\n      if (isDocumentFragment)\r\n      {\r\n         for (const svelteData of this.#svelteData)\r\n         {\r\n            if (svelteData.element instanceof HTMLElement)\r\n            {\r\n               this._element = $(svelteData.element);\r\n               break;\r\n            }\r\n         }\r\n      }\r\n\r\n      // Potentially retrieve a specific target element if `selectorTarget` is defined otherwise make the target the\r\n      // main element.\r\n      this.#targetElement = typeof this.options.selectorTarget === 'string' ?\r\n       this._element.find(this.options.selectorTarget) : this._element;\r\n\r\n      if (this.#targetElement === null || this.#targetElement === void 0 || this.#targetElement.length === 0)\r\n      {\r\n         throw new Error(`SvelteApplication - _injectHTML: Target element '${this.options.selectorTarget}' not found.`);\r\n      }\r\n\r\n      this.onSvelteMount({ element: this._element[0], targetElement: this.#targetElement[0] });\r\n   }\r\n\r\n   /**\r\n    * Provides a callback after all Svelte components are initialized.\r\n    *\r\n    * @param {object}      opts - Options.\r\n    *\r\n    * @param {HTMLElement} opts.element - HTMLElement container for main application element.\r\n    *\r\n    * @param {HTMLElement} opts.targetElement - HTMLElement container for main application target element.\r\n    */\r\n   onSvelteMount({ element, targetElement }) {} // eslint-disable-line no-unused-vars\r\n\r\n   /**\r\n    * Override replacing HTML as Svelte components control the rendering process. Only potentially change the outer\r\n    * application frame / title for pop-out applications.\r\n    *\r\n    * @override\r\n    * @inheritDoc\r\n    */\r\n   _replaceHTML(element, html)  // eslint-disable-line no-unused-vars\r\n   {\r\n      if (!element.length) { return; }\r\n\r\n      // For pop-out windows update the window title\r\n      if (this.popOut)\r\n      {\r\n         element.find('.window-title').text(this.title);\r\n      }\r\n   }\r\n\r\n   /**\r\n    * Render the inner application content. Only render a template if one is defined otherwise provide an empty\r\n    * JQuery element.\r\n    *\r\n    * @param {Object} data         The data used to render the inner template\r\n    *\r\n    * @returns {Promise.<JQuery>}   A promise resolving to the constructed jQuery object\r\n    *\r\n    * @override\r\n    * @private\r\n    */\r\n   async _renderInner(data)\r\n   {\r\n      const html = typeof this.template === 'string' ? await renderTemplate(this.template, data) :\r\n       document.createDocumentFragment();\r\n\r\n      return $(html);\r\n   }\r\n\r\n   /**\r\n    * Modified Application `setPosition` to support QuestTrackerApp for switchable resizable window.\r\n    * Set the application position and store its new location.\r\n    *\r\n    * @param {object}               [opts] - Optional parameters.\r\n    *\r\n    * @param {number|null}          [opts.left] - The left offset position in pixels\r\n    *\r\n    * @param {number|null}          [opts.top] - The top offset position in pixels\r\n    *\r\n    * @param {number|null}          [opts.width] - The application width in pixels\r\n    *\r\n    * @param {number|string|null}   [opts.height] - The application height in pixels\r\n    *\r\n    * @param {number|null}          [opts.scale] - The application scale as a numeric factor where 1.0 is default\r\n    *\r\n    * @param {boolean}              [opts.noHeight] - When true no element height is modified.\r\n    *\r\n    * @param {boolean}              [opts.noWidth] - When true no element Width is modified.\r\n    *\r\n    * @returns {{left: number, top: number, width: number, height: number, scale:number}}\r\n    * The updated position object for the application containing the new values\r\n    */\r\n   setPosition({ left, top, width, height, scale, noHeight = false, noWidth = false } = {})\r\n   {\r\n      const el = this.targetElement[0];\r\n      const currentPosition = this.position;\r\n      const styles = window.getComputedStyle(el);\r\n\r\n      // Update width if an explicit value is passed, or if no width value is set on the element\r\n      if (!el.style.width || width)\r\n      {\r\n         const tarW = width || el.offsetWidth;\r\n         const minW = parseInt(styles.minWidth) || MIN_WINDOW_WIDTH;\r\n         const maxW = el.style.maxWidth || window.innerWidth;\r\n         currentPosition.width = width = Math.clamped(tarW, minW, maxW);\r\n\r\n         if (!noWidth) { el.style.width = `${width}px`; }\r\n         if ((width + currentPosition.left) > window.innerWidth) { left = currentPosition.left; }\r\n      }\r\n      width = el.offsetWidth;\r\n\r\n      // Update height if an explicit value is passed, or if no height value is set on the element\r\n      if (!el.style.height || height)\r\n      {\r\n         const tarH = height || (el.offsetHeight + 1);\r\n         const minH = parseInt(styles.minHeight) || MIN_WINDOW_HEIGHT;\r\n         const maxH = el.style.maxHeight || window.innerHeight;\r\n         currentPosition.height = height = Math.clamped(tarH, minH, maxH);\r\n\r\n         if (!noHeight) { el.style.height = `${height}px`; }\r\n         if ((height + currentPosition.top) > window.innerHeight + 1) { top = currentPosition.top - 1; }\r\n      }\r\n      height = el.offsetHeight;\r\n\r\n      // Update Left\r\n      if ((!el.style.left) || Number.isFinite(left))\r\n      {\r\n         const tarL = Number.isFinite(left) ? left : (window.innerWidth - width) / 2;\r\n         const maxL = Math.max(window.innerWidth - width, 0);\r\n         currentPosition.left = left = Math.clamped(tarL, 0, maxL);\r\n         el.style.left = `${left}px`;\r\n      }\r\n\r\n      // Update Top\r\n      if ((!el.style.top) || Number.isFinite(top))\r\n      {\r\n         const tarT = Number.isFinite(top) ? top : (window.innerHeight - height) / 2;\r\n         const maxT = Math.max(window.innerHeight - height, 0);\r\n         currentPosition.top = top = Math.clamped(tarT, 0, maxT);\r\n         el.style.top = `${currentPosition.top}px`;\r\n      }\r\n\r\n      // Update Scale\r\n      if (scale)\r\n      {\r\n         currentPosition.scale = Math.max(scale, 0);\r\n         if (scale === 1) { el.style.transform = \"\"; }\r\n         else { el.style.transform = `scale(${scale})`; }\r\n      }\r\n\r\n      // Return the updated position object\r\n      return currentPosition;\r\n   }\r\n}\r\n\r\n/**\r\n * Instantiates and attaches a Svelte component to the main inserted HTML.\r\n *\r\n * @param {Application} app - The application\r\n *\r\n * @param {JQuery}      html - The inserted HTML.\r\n *\r\n * @param {object}      config - Svelte component options\r\n *\r\n * @returns {object} The config + instantiated Svelte component.\r\n */\r\nfunction s_LOAD_CONFIG(app, html, config)\r\n{\r\n   const svelteOptions = typeof config.options === 'object' ? config.options : {};\r\n\r\n   const injectApp = typeof svelteOptions.injectApp === 'boolean' ? svelteOptions.injectApp : false;\r\n   const injectEventbus = typeof svelteOptions.injectEventbus === 'boolean' ? svelteOptions.injectEventbus : false;\r\n\r\n   if (typeof app.template === 'string' && typeof config.target !== 'string')\r\n   {\r\n      throw new TypeError(\r\n       `SvelteApplication - s_LOAD_CONFIG - Template defined and target selector not a string for config:\\n${\r\n        JSON.stringify(config)}`);\r\n   }\r\n\r\n   if (config.target instanceof HTMLElement && typeof svelteOptions.selectorElement !== 'string')\r\n   {\r\n      throw new Error(\r\n       `SvelteApplication - s_LOAD_CONFIG - HTMLElement target with no 'selectorElement' defined for config:\\n${\r\n        JSON.stringify(config)}`);\r\n   }\r\n\r\n   let target;\r\n\r\n   if (config.target instanceof HTMLElement)       // A specific HTMLElement to append Svelte component.\r\n   {\r\n      target = config.target;\r\n   }\r\n   else if (typeof config.target === 'string')     // A string target defines a selector to find in existing HTML.\r\n   {\r\n      target = html.find(config.target).get(0);\r\n   }\r\n   else                                            // No target defined, create a document fragment.\r\n   {\r\n      target = document.createDocumentFragment();\r\n   }\r\n\r\n   if (target === void 0)\r\n   {\r\n      throw new Error(\r\n       `SvelteApplication - s_LOAD_CONFIG - could not find target selector: ${config.target} for config:\\n${\r\n        JSON.stringify(config)}`);\r\n   }\r\n\r\n   const SvelteComponent = config.class;\r\n\r\n   const svelteConfig = parseSvelteConfig({ ...config, target }, app);\r\n\r\n   // Potentially inject the Foundry application instance as a Svelte prop.\r\n   if (injectApp)\r\n   {\r\n      svelteConfig.context.get('external').foundryApp = app;\r\n   }\r\n\r\n   let eventbus;\r\n\r\n   // Potentially inject any TyphonJS eventbus and track the proxy in the options.\r\n   if (injectEventbus && typeof app._eventbus === 'object' && typeof app._eventbus.createProxy === 'function')\r\n   {\r\n      eventbus = app._eventbus.createProxy();\r\n      svelteConfig.context.get('external').eventbus = eventbus;\r\n   }\r\n\r\n   // Create the Svelte component.\r\n   const component = new SvelteComponent(svelteConfig);\r\n\r\n   // Set any eventbus to the config.\r\n   svelteConfig.eventbus = eventbus;\r\n\r\n   let element;\r\n\r\n   // Detect if target is a synthesized DocumentFragment with an child element. Child elements will be present\r\n   // if the Svelte component mounts and renders initial content into the document fragment.\r\n   if (target instanceof DocumentFragment && target.firstElementChild)\r\n   {\r\n      element = target.firstElementChild;\r\n      html.append(target);\r\n   }\r\n   else if (config.target instanceof HTMLElement)\r\n   {\r\n      // The target is an HTMLElement so find the Application element from `selectorElement` option.\r\n      element = target.querySelector(svelteOptions.selectorElement);\r\n\r\n      if (element === null || element === void 0)\r\n      {\r\n         throw new Error(\r\n          `SvelteApplication - s_LOAD_CONFIG - HTMLElement target - could not find 'selectorElement' for config:\\n${\r\n           JSON.stringify(config)}`);\r\n      }\r\n   }\r\n\r\n   const result = { config: svelteConfig, component, element };\r\n\r\n   Object.freeze(result);\r\n\r\n   return { config: svelteConfig, component, element };\r\n}","import { TJSContextMenu }  from '@typhonjs-fvtt/svelte/component';\r\n\r\n/**\r\n * Provides game wide menu functionality.\r\n */\r\nexport class TJSMenu\r\n{\r\n   /**\r\n    * Stores any active context menu.\r\n    */\r\n   static #contextMenu = void 0;\r\n\r\n   /**\r\n    * Creates and manages a game wide context menu.\r\n    *\r\n    * @param {object}   opts - Optional parameters.\r\n    *\r\n    * @param {string}   [opts.id] - A custom CSS ID to add to the menu.\r\n    *\r\n    * @param {number}   opts.x - X position for the top / left of the menu.\r\n    *\r\n    * @param {number}   opts.y - Y position for the top / left of the menu.\r\n    *\r\n    * @param {object[]} opts.items - Menu items to display.\r\n    *\r\n    * @param {number}   [opts.zIndex=10000] - Z-index for context menu.\r\n    *\r\n    * @param {...*}     [opts.transitionOptions] - The rest of opts defined the slideFade transition options.\r\n    */\r\n   static createContext({id = '', x = 0, y = 0, items = [], zIndex = 10000, ...transitionOptions} = {})\r\n   {\r\n      if (this.#contextMenu !== void 0) { return; }\r\n\r\n      // Create the new context menu with the last click x / y point.\r\n      this.#contextMenu = new TJSContextMenu({\r\n         target: document.body,\r\n         intro: true,\r\n         props: { id, x, y, items, zIndex, transitionOptions }\r\n      });\r\n\r\n      // Register an event listener to remove any active context menu if closed from a menu selection or pointer\r\n      // down event to `document.body`.\r\n      this.#contextMenu.$on('close', () => { this.#contextMenu = void 0; });\r\n   }\r\n}"],"names":["SvelteApplication","Application","constructor","options","svelteDataLength","length","targetElement","close","states","RENDER_STATES","force","RENDERED","ERROR","includes","_state","CLOSING","el","CLOSED","style","minHeight","cls","_getInheritanceChain","Hooks","call","name","Promise","resolve","slideUp","svelteDestroyPromises","entry","push","outroAndDestroy","component","eventbus","config","off","all","remove","_element","ui","windows","appId","_minimized","_scrollPositions","getSvelteData","index","getSvelteDataEntries","entries","getSvelteDataValues","values","_injectHTML","html","popOut","Array","isArray","svelte","Error","svelteConfig","s_LOAD_CONFIG","TypeError","isDocumentFragment","DocumentFragment","svelteData","element","HTMLElement","$","selectorTarget","find","onSvelteMount","_replaceHTML","text","title","_renderInner","data","template","renderTemplate","document","createDocumentFragment","setPosition","left","top","width","height","scale","noHeight","noWidth","currentPosition","position","styles","window","getComputedStyle","tarW","offsetWidth","minW","parseInt","minWidth","MIN_WINDOW_WIDTH","maxW","maxWidth","innerWidth","Math","clamped","tarH","offsetHeight","minH","MIN_WINDOW_HEIGHT","maxH","maxHeight","innerHeight","Number","isFinite","tarL","maxL","max","tarT","maxT","transform","app","svelteOptions","injectApp","injectEventbus","target","JSON","stringify","selectorElement","get","SvelteComponent","class","parseSvelteConfig","context","foundryApp","_eventbus","createProxy","firstElementChild","append","querySelector","result","Object","freeze","TJSMenu","createContext","id","x","y","items","zIndex","transitionOptions","TJSContextMenu","body","intro","props","$on"],"mappings":"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"}