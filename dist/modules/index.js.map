{"version":3,"file":"index.js","sources":["../../src/modules/application/SvelteApplication.js","../../src/modules/application/TJSMenu.js"],"sourcesContent":["/**\r\n * Provides a Svelte aware extension to Application to control the app lifecycle appropriately. You can declaratively\r\n * load one or more components from `defaultOptions`. For the time being please refer to this temporary demo code\r\n * in `typhonjs-quest-log` for examples of how to declare Svelte components.\r\n * {@link https://github.com/typhonjs-fvtt/typhonjs-quest-log/tree/master/src/view/demo}\r\n *\r\n * A repository of demos will be available soon.\r\n */\r\nexport class SvelteApplication extends Application\r\n{\r\n   /**\r\n    * Stores instantiated Svelte components.\r\n    *\r\n    * @type {object[]}\r\n    * @private\r\n    */\r\n   #svelteComponents = [];\r\n\r\n   /**\r\n    * @inheritDoc\r\n    */\r\n   constructor(options)\r\n   {\r\n      super(options);\r\n   }\r\n\r\n   /**\r\n    * Note: This method is fully overridden and duplicated as Svelte components need to be destroyed manually and the\r\n    * best visual result is to destroy them after the default JQuery slide up animation occurs, but before the element\r\n    * is removed from the DOM.\r\n    *\r\n    * If you destroy the Svelte components before the slide up animation the Svelte elements are removed immediately\r\n    * from the DOM. The purpose of overriding ensures the slide up animation is always completed before\r\n    * the Svelte components are destroyed and then the element is removed from the DOM.\r\n    *\r\n    * Close the application and un-register references to it within UI mappings.\r\n    * This function returns a Promise which resolves once the window closing animation concludes\r\n    *\r\n    * @param {object}   options - Optional parameters.\r\n    *\r\n    * @param {boolean}  options.force - Force close regardless of render state.\r\n    *\r\n    * @returns {Promise<void|number>}    A Promise which resolves once the application is closed\r\n    */\r\n   async close(options = {})\r\n   {\r\n      const states = Application.RENDER_STATES;\r\n      if (!options.force && ![states.RENDERED, states.ERROR].includes(this._state)) { return; }\r\n\r\n      this._state = states.CLOSING;\r\n\r\n      /**\r\n       * Get the element.\r\n       *\r\n       * @type {JQuery}\r\n       */\r\n      const el = this.element;\r\n      if (!el) { return this._state = states.CLOSED; }\r\n\r\n      el.css({ minHeight: 0 });\r\n\r\n      // Dispatch Hooks for closing the base and subclass applications\r\n      for (const cls of this.constructor._getInheritanceChain())\r\n      {\r\n         /**\r\n          * A hook event that fires whenever this Application is closed.\r\n          *\r\n          * @param {Application} app                     The Application instance being closed\r\n          *\r\n          * @param {jQuery[]} html                       The application HTML when it is closed\r\n          *\r\n          * @function closeApplication\r\n          *\r\n          * @memberof hookEvents\r\n          */\r\n         Hooks.call(`close${cls.name}`, this, el);\r\n      }\r\n\r\n      // Animate closing the element\r\n      return new Promise((resolve) =>\r\n      {\r\n         el.slideUp(200, () =>\r\n         {\r\n            // Manually invoke the destroy callbacks for all Svelte components.\r\n            for (const entry of this.#svelteComponents)\r\n            {\r\n               entry.component?.$destroy();\r\n\r\n               const eventbus = entry.config.eventbus;\r\n               if (typeof eventbus === 'object' && typeof eventbus.off === 'function')\r\n               {\r\n                  eventbus.off();\r\n                  entry.config.eventbus = void 0;\r\n               }\r\n            }\r\n\r\n            this.#svelteComponents = [];\r\n\r\n            el.remove();\r\n\r\n            // Clean up data\r\n            this._element = null;\r\n            delete ui.windows[this.appId];\r\n            this._minimized = false;\r\n            this._scrollPositions = null;\r\n            this._state = states.CLOSED;\r\n            resolve();\r\n         });\r\n      });\r\n   }\r\n\r\n   /**\r\n    * Returns the indexed Svelte component\r\n    * @param {number}   index -\r\n    *\r\n    * @returns {object}\r\n    */\r\n   getSvelteComponent(index)\r\n   {\r\n      return this.#svelteComponents[index];\r\n   }\r\n\r\n   /**\r\n    * Inject the Svelte components defined in `this.options.svelte`. The Svelte component can attach to the existing\r\n    * pop-out of Application or provide no template and render into a document fragment which is then attached to the\r\n    * DOM.\r\n    *\r\n    * @param {JQuery} html -\r\n    *\r\n    * @override\r\n    * @inheritDoc\r\n    */\r\n   _injectHTML(html)\r\n   {\r\n      if (this.popOut && html.length === 0 && Array.isArray(this.options.svelte))\r\n      {\r\n         throw new Error(\r\n          'SvelteApplication - _injectHTML - A popout app with no template can only support one Svelte component.');\r\n      }\r\n\r\n      if (Array.isArray(this.options.svelte))\r\n      {\r\n         for (const svelteConfig of this.options.svelte)\r\n         {\r\n            this.#svelteComponents.push(s_LOAD_CONFIG(this, html, svelteConfig));\r\n         }\r\n      }\r\n      else if (typeof this.options.svelte === 'object')\r\n      {\r\n         this.#svelteComponents.push(s_LOAD_CONFIG(this, html, this.options.svelte));\r\n      }\r\n      else\r\n      {\r\n         throw new TypeError(`SvelteApplication - _injectHTML - this.options.svelte not an array or object.`);\r\n      }\r\n\r\n      // Detect if this is a synthesized DocumentFragment.\r\n      const isDocumentFragment = html.length && html[0] instanceof DocumentFragment && html[0].firstElementChild;\r\n\r\n      // Store first child element if DocumentFragment.\r\n      const newElement = isDocumentFragment ? $(html[0].firstElementChild) : void 0;\r\n\r\n      super._injectHTML(html);\r\n\r\n      // Set the element of the app to the first child of any document fragment.\r\n      if (isDocumentFragment)\r\n      {\r\n         this._element = newElement;\r\n      }\r\n\r\n      this.onSvelteMount(this.element);\r\n   }\r\n\r\n   /**\r\n    * Provides a callback after all Svelte components are initialized.\r\n    *\r\n    * @param {JQuery} element - JQuery container for main application element.\r\n    */\r\n   onSvelteMount(element) {} // eslint-disable-line no-unused-vars\r\n\r\n   /**\r\n    * Override replacing HTML as Svelte components control the rendering process. Only potentially change the outer\r\n    * application frame / title for pop-out applications.\r\n    *\r\n    * @override\r\n    * @inheritDoc\r\n    */\r\n   _replaceHTML(element, html)  // eslint-disable-line no-unused-vars\r\n   {\r\n      if (!element.length) { return; }\r\n\r\n      // For pop-out windows update the window title\r\n      if (this.popOut)\r\n      {\r\n         element.find('.window-title').text(this.title);\r\n      }\r\n   }\r\n\r\n   /**\r\n    * Render the inner application content. Only render a template if one is defined otherwise provide an empty\r\n    * JQuery element.\r\n    *\r\n    * @param {Object} data         The data used to render the inner template\r\n    *\r\n    * @returns {Promise.<JQuery>}   A promise resolving to the constructed jQuery object\r\n    *\r\n    * @override\r\n    * @private\r\n    */\r\n   async _renderInner(data)\r\n   {\r\n      const html = typeof this.template === 'string' ? await renderTemplate(this.template, data) :\r\n       document.createDocumentFragment();\r\n\r\n      return $(html);\r\n   }\r\n}\r\n\r\n/**\r\n * Instantiates and attaches a Svelte component to the main inserted HTML.\r\n *\r\n * @param {Application} app - The application\r\n *\r\n * @param {JQuery}      html - The inserted HTML.\r\n *\r\n * @param {object}      config - Svelte component options\r\n *\r\n * @returns {object} The config + instantiated Svelte component.\r\n */\r\nfunction s_LOAD_CONFIG(app, html, config)\r\n{\r\n   const svelteOptions = typeof config.options === 'object' ? config.options : {};\r\n\r\n   const injectApp = typeof svelteOptions.injectApp === 'boolean' ? svelteOptions.injectApp : false;\r\n   const injectEventbus = typeof svelteOptions.injectEventbus === 'boolean' ? svelteOptions.injectEventbus : false;\r\n   const hasTemplate = typeof app.template === 'string';\r\n   const hasTarget = typeof config.target === 'string';\r\n\r\n   if (typeof config.class !== 'function')\r\n   {\r\n      throw new TypeError(\r\n       `SvelteApplication - s_LOAD_CONFIG - class not a constructor for config:\\n${JSON.stringify(config)}.`);\r\n   }\r\n\r\n   if (hasTemplate && !hasTarget)\r\n   {\r\n      throw new TypeError(`SvelteApplication - s_LOAD_CONFIG - target selector not a string for config:\\n${\r\n       JSON.stringify(config)}`);\r\n   }\r\n\r\n   // If a target selector is defined then find it in the JQuery `html` otherwise create an empty fragment.\r\n   const target = hasTarget ? html.find(config.target).get(0) : document.createDocumentFragment();\r\n\r\n   if (target === void 0)\r\n   {\r\n      throw new Error(\r\n       `SvelteApplication - s_LOAD_CONFIG - could not find target selector: ${config.target} for config:\\n${\r\n        JSON.stringify(config)}`);\r\n   }\r\n\r\n   const SvelteComponent = config.class;\r\n\r\n   if (typeof SvelteComponent !== 'function')\r\n   {\r\n      throw new Error(\r\n       `SvelteApplication - s_LOAD_CONFIG - class is not defined for config:\\n${JSON.stringify(config)}`);\r\n   }\r\n\r\n   const svelteConfig = { ...config, target  };\r\n\r\n   delete svelteConfig.options;\r\n\r\n   let externalContext = {};\r\n\r\n   // If a context callback function is provided then invoke it with `this` being the Foundry app.\r\n   // If an object is returned it adds the entries to external context.\r\n   if (typeof svelteConfig.context === 'function')\r\n   {\r\n      const context = svelteConfig.context;\r\n      delete svelteConfig.context;\r\n\r\n      const result = context.call(app);\r\n      if (typeof result === 'object')\r\n      {\r\n         externalContext = { ...externalContext, ...result };\r\n      }\r\n   }\r\n\r\n   // Process children components attaching to external context.\r\n   if (Array.isArray(svelteConfig.children))\r\n   {\r\n      externalContext.children = [];\r\n      for (let cntr = 0; cntr < svelteConfig.children.length; cntr++)\r\n      {\r\n         const child = svelteConfig.children[cntr];\r\n\r\n         if (typeof child.class !== 'function')\r\n         {\r\n            throw new Error(\r\n             `SvelteApplication - s_LOAD_CONFIG - class is not defined for child[${cntr}] for config:\\n${\r\n              JSON.stringify(config)}`);\r\n         }\r\n\r\n         externalContext.children.push(child);\r\n      }\r\n\r\n      delete svelteConfig.children;\r\n   }\r\n   else if (typeof svelteConfig.children === 'object')\r\n   {\r\n      if (typeof svelteConfig.children.class !== 'function')\r\n      {\r\n         throw new Error(\r\n          `SvelteApplication - s_LOAD_CONFIG - class is not defined for children object for config:\\n${\r\n           JSON.stringify(config)}`);\r\n      }\r\n\r\n      externalContext.children = [svelteConfig.children];\r\n      delete svelteConfig.children;\r\n   }\r\n\r\n   // Potentially inject the Foundry application instance as a Svelte prop.\r\n   if (injectApp)\r\n   {\r\n      externalContext.foundryApp = app;\r\n   }\r\n\r\n   let eventbus;\r\n\r\n   // Potentially inject any TyphonJS eventbus and track the proxy in the options.\r\n   if (injectEventbus && typeof app._eventbus === 'object' && typeof app._eventbus.createProxy === 'function')\r\n   {\r\n      eventbus = app._eventbus.createProxy();\r\n      externalContext.eventbus = eventbus;\r\n   }\r\n\r\n   // If there is a context object then set it to props.\r\n   if (Object.keys(externalContext).length > 0)\r\n   {\r\n      // If there is an existing context Map then merge with external context.\r\n      svelteConfig.context = svelteConfig.context instanceof Map ?\r\n       new Map([['external', externalContext], ...svelteConfig.context]) :\r\n        new Map([['external', externalContext]]);\r\n   }\r\n\r\n   // Create the Svelte component.\r\n   const component = new SvelteComponent(svelteConfig);\r\n\r\n   // Set any eventbus to the config.\r\n   svelteConfig.eventbus = eventbus;\r\n\r\n   const result = { config: svelteConfig, component };\r\n\r\n   if (!hasTarget)\r\n   {\r\n      html.append(target);\r\n   }\r\n\r\n   return result;\r\n}","import { TJSContextMenu }  from '@typhonjs-fvtt/svelte/component';\r\n\r\n/**\r\n * Provides game wide menu functionality.\r\n */\r\nexport class TJSMenu\r\n{\r\n   /**\r\n    * Stores any active context menu.\r\n    */\r\n   static #contextMenu = void 0;\r\n\r\n   /**\r\n    * Creates and manages a game wide context menu.\r\n    *\r\n    * @param {object}   opts - Optional parameters.\r\n    *\r\n    * @param {string}   [opts.id] - A custom CSS ID to add to the menu.\r\n    *\r\n    * @param {number}   opts.x - X position for the top / left of the menu.\r\n    *\r\n    * @param {number}   opts.y - Y position for the top / left of the menu.\r\n    *\r\n    * @param {object[]} opts.items - Menu items to display.\r\n    *\r\n    * @param {number}   [opts.zIndex=10000] - Z-index for context menu.\r\n    *\r\n    * @param {...*}     [opts.transitionOptions] - The rest of opts defined the slideFade transition options.\r\n    */\r\n   static createContext({id = '', x = 0, y = 0, items = [], zIndex = 10000, ...transitionOptions} = {})\r\n   {\r\n      if (this.#contextMenu !== void 0) { return; }\r\n\r\n      // Create the new context menu with the last click x / y point.\r\n      this.#contextMenu = new TJSContextMenu({\r\n         target: document.body,\r\n         intro: true,\r\n         props: { id, x, y, items, zIndex, transitionOptions }\r\n      });\r\n\r\n      // Register an event listener to remove any active context menu if closed from a menu selection or pointer\r\n      // down event to `document.body`.\r\n      this.#contextMenu.$on('close', () => { this.#contextMenu = void 0; });\r\n   }\r\n}"],"names":["SvelteApplication","Application","constructor","options","close","states","RENDER_STATES","force","RENDERED","ERROR","includes","_state","CLOSING","el","element","CLOSED","css","minHeight","cls","_getInheritanceChain","Hooks","call","name","Promise","resolve","slideUp","entry","component","$destroy","eventbus","config","off","remove","_element","ui","windows","appId","_minimized","_scrollPositions","getSvelteComponent","index","_injectHTML","html","popOut","length","Array","isArray","svelte","Error","svelteConfig","push","s_LOAD_CONFIG","TypeError","isDocumentFragment","DocumentFragment","firstElementChild","newElement","$","onSvelteMount","_replaceHTML","find","text","title","_renderInner","data","template","renderTemplate","document","createDocumentFragment","app","svelteOptions","injectApp","injectEventbus","hasTemplate","hasTarget","target","class","JSON","stringify","get","SvelteComponent","externalContext","context","result","children","cntr","child","foundryApp","_eventbus","createProxy","Object","keys","Map","append","TJSMenu","createContext","id","x","y","items","zIndex","transitionOptions","TJSContextMenu","body","intro","props","$on"],"mappings":"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"}